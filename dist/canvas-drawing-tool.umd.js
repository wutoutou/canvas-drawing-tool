!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CanvasDrawingTool={})}(this,function(t){"use strict";class e{constructor(){this.events=new Map}on(t,e){this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(e)}off(t,e){this.events.has(t)&&this.events.get(t).delete(e)}emit(t,e){this.events.has(t)&&this.events.get(t).forEach(s=>{try{s(e)}catch(e){console.error(`Error in event handler for ${t}:`,e)}})}clear(){this.events.clear()}}class s{constructor(t,e,s){this.id=t,this.type=e,this.data=s}draw(t){}containsPoint(t){return!1}toJSON(){return{id:this.id,type:this.type,data:{...this.data}}}static fromJSON(t){return new s(t.id,t.type,t.data)}}class i extends s{constructor(t,e){super(t,"rectangle",e)}draw(t){t.save(),t.strokeStyle=this.data.color,t.lineWidth=this.data.lineWidth,t.strokeRect(this.data.x,this.data.y,this.data.width,this.data.height),t.restore()}containsPoint(t,e=5){const{x:s,y:i,width:r,height:a}=this.data;return t.x>=s-e&&t.x<=s+r+e&&t.y>=i-e&&t.y<=i+a+e}}class r extends s{constructor(t,e){super(t,"circle",e)}draw(t){t.save(),t.strokeStyle=this.data.color,t.lineWidth=this.data.lineWidth,t.beginPath(),t.arc(this.data.x,this.data.y,this.data.radius,0,2*Math.PI),t.stroke(),t.restore()}containsPoint(t,e=5){const{x:s,y:i,radius:r}=this.data;return Math.sqrt((t.x-s)**2+(t.y-i)**2)<=r+e}}class a extends s{constructor(t,e){super(t,"polygon",e)}draw(t){if(!(this.data.points.length<3)){t.save(),t.strokeStyle=this.data.color,t.lineWidth=this.data.lineWidth,t.beginPath(),t.moveTo(this.data.points[0].x,this.data.points[0].y);for(let e=1;e<this.data.points.length;e++)t.lineTo(this.data.points[e].x,this.data.points[e].y);t.closePath(),t.stroke(),t.restore()}}containsPoint(t,e=5){const{points:s}=this.data;if(s.length<3)return!1;let i=!1;for(let e=0,r=s.length-1;e<s.length;r=e++){const a=s[e].x,n=s[e].y,h=s[r].x,o=s[r].y;n>t.y!=o>t.y&&t.x<(h-a)*(t.y-n)/(o-n)+a&&(i=!i)}return i}}class n extends s{constructor(t,e){super(t,"brush",e)}draw(t){if(!(this.data.points.length<2)){t.save(),t.strokeStyle=this.data.color,t.lineWidth=this.data.lineWidth,t.beginPath(),t.moveTo(this.data.points[0].x,this.data.points[0].y);for(let e=1;e<this.data.points.length;e++)t.lineTo(this.data.points[e].x,this.data.points[e].y);t.stroke(),t.restore()}}containsPoint(t,e=5){const{points:s,lineWidth:i}=this.data;if(s.length<2)return!1;for(let r=1;r<s.length;r++){const a=s[r-1],n=s[r];if(this._pointToLineDistance(t,a,n)<=i/2+e)return!0}return!1}_pointToLineDistance(t,e,s){const i=t.x-e.x,r=t.y-e.y,a=s.x-e.x,n=s.y-e.y,h=a*a+n*n;let o,c,d=-1;0!==h&&(d=(i*a+r*n)/h),d<0?(o=e.x,c=e.y):d>1?(o=s.x,c=s.y):(o=e.x+d*a,c=e.y+d*n);const l=t.x-o,u=t.y-c;return Math.sqrt(l*l+u*u)}}class h{static createShape(t){const{type:e,data:s,id:h}=t;switch(e){case"rectangle":return new i(h,s);case"circle":return new r(h,s);case"polygon":return new a(h,s);case"brush":return new n(h,s);default:return console.warn(`Unknown shape type: ${e}`),null}}static createShapeFromJSON(t){return this.createShape(t)}}class o{constructor(t,s){this.container=t,this.config=s,this.canvas=null,this.ctx=null,this.shapes=new Map,this.eventManager=new e,this.isDrawing=!1,this._initializeCanvas(),this._bindEvents()}_initializeCanvas(){this.canvas=document.createElement("canvas"),this.canvas.width=this.config.width,this.canvas.height=this.config.height,this.canvas.style.backgroundColor=this.config.backgroundColor,this.canvas.style.cursor="crosshair",this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.currentColor=this.config.defaultColor,this.currentLineWidth=this.config.defaultLineWidth}_bindEvents(){this.canvas.addEventListener("mousedown",this._handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this._handleMouseUp.bind(this)),this.canvas.addEventListener("dblclick",this._handleDoubleClick.bind(this))}_handleMouseDown(t){const e=this._getMousePosition(t);this.eventManager.emit("mousedown",{point:e,event:t})}_handleMouseMove(t){const e=this._getMousePosition(t);this.eventManager.emit("mousemove",{point:e,event:t})}_handleMouseUp(t){const e=this._getMousePosition(t);this.eventManager.emit("mouseup",{point:e,event:t})}_handleDoubleClick(t){const e=this._getMousePosition(t);this.eventManager.emit("dblclick",{point:e,event:t})}_getMousePosition(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}setColor(t){this.currentColor=t,this.ctx.strokeStyle=t}setLineWidth(t){this.currentLineWidth=t,this.ctx.lineWidth=t}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.shapes.clear(),this.eventManager.clear(),this.eventManager.emit("clear")}addShape(t){const e=h.createShape(t);e&&(this.shapes.set(e.id,e),this._redraw(),this.eventManager.emit("shapeAdded",{shape:e}))}removeShape(t){if(this.shapes.has(t)){const e=this.shapes.get(t);this.shapes.delete(t),this._redraw(),this.eventManager.emit("shapeRemoved",{shape:e})}}getShapes(){return Array.from(this.shapes.values())}getShape(t){return this.shapes.get(t)}_redraw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.shapes.forEach(t=>{t.draw(this.ctx)})}exportImage(t="image/png",e=1){return this.canvas.toDataURL(t,e)}importData(t){this.clear(),t.forEach(t=>{this.addShape(t)})}exportData(){return this.getShapes().map(t=>t.toJSON())}on(t,e){this.eventManager.on(t,e)}off(t,e){this.eventManager.off(t,e)}resetEvent(){this.eventManager.clear()}destroy(){this.canvas.remove(),this.eventManager.clear()}setSize(t,e){const s=this.getDataUrl();this.canvas.width=t,this.canvas.height=e;const i=new Image;i.onload=()=>{this.ctx.fillStyle=this.config.backgroundColor,this.ctx.fillRect(0,0,t,e),this.ctx.drawImage(i,0,0)},i.src=s}setBackgroundColor(t){this.config.backgroundColor=t;const e=this.getDataUrl();this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const s=new Image;s.onload=()=>{this.ctx.drawImage(s,0,0)},s.src=e}getDataUrl(t="image/png",e=1){return this.canvas.toDataURL(t,e)}}function c(t,e,s){const i=t.x-e.x,r=t.y-e.y,a=s.x-e.x,n=s.y-e.y,h=a*a+n*n;let o,c,d=-1;0!==h&&(d=(i*a+r*n)/h),d<0?(o=e.x,c=e.y):d>1?(o=s.x,c=s.y):(o=e.x+d*a,c=e.y+d*n);const l=t.x-o,u=t.y-c;return Math.sqrt(l*l+u*u)}function d(t,e){if(e.length<3)return!1;let s=!1;for(let i=0,r=e.length-1;i<e.length;r=i++){const a=e[i].x,n=e[i].y,h=e[r].x,o=e[r].y;n>t.y!=o>t.y&&t.x<(h-a)*(t.y-n)/(o-n)+a&&(s=!s)}return s}function l(t=""){return`${t}${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function u(t,e,s=0){return t.x>=e.x-s&&t.x<=e.x+e.width+s&&t.y>=e.y-s&&t.y<=e.y+e.height+s}function p(t,e,s=0){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)<=e.radius+s}class g{constructor(t){this.drawer=t,this.name="base",this.isDrawing=!1,this.currentShape=null}activate(){this._bindEvents()}deactivate(){this._unbindEvents()}_bindEvents(){this.drawer.on("mousedown",this._onMouseDown.bind(this)),this.drawer.on("mousemove",this._onMouseMove.bind(this)),this.drawer.on("mouseup",this._onMouseUp.bind(this)),this.drawer.on("dblclick",this._onDoubleClick.bind(this))}_unbindEvents(){}_onMouseDown({point:t,event:e}){}_onMouseMove({point:t,event:e}){}_onMouseUp({point:t,event:e}){}_onDoubleClick({point:t,event:e}){}_createShape(t,e){return{id:l(t),type:t,data:{...e,color:this.drawer.currentColor,lineWidth:this.drawer.currentLineWidth,createdAt:(new Date).toISOString()}}}}class w extends g{constructor(t){super(t),this.name="brush",this.points=[]}_onMouseDown({point:t,event:e}){this.isDrawing=!0,this.points=[t],this.currentShape=this._createShape("brush",{points:[t],isComplete:!1}),this.drawer.ctx.beginPath(),this.drawer.ctx.moveTo(t.x,t.y)}_onMouseMove({point:t,event:e}){this.isDrawing&&(this.points.push(t),this.currentShape.data.points=this.points,this.drawer.ctx.lineTo(t.x,t.y),this.drawer.ctx.stroke())}_onMouseUp({point:t,event:e}){this.isDrawing&&(this.isDrawing=!1,this.currentShape.data.isComplete=!0,this.currentShape.data.points=[...this.points],this.points.length>1&&this.drawer.addShape(this.currentShape),this.points=[],this.currentShape=null)}_unbindEvents(){this.isDrawing=!1,this.points=[],this.currentShape=null,this.drawer.resetEvent()}}class v extends g{constructor(t){super(t),this.name="rectangle",this.startPoint=null}_onMouseDown({point:t,event:e}){this.isDrawing=!0,this.startPoint=t,this.currentShape=this._createShape("rectangle",{x:t.x,y:t.y,width:0,height:0})}_onMouseMove({point:t,event:e}){if(!this.isDrawing)return;const s=t.x-this.startPoint.x,i=t.y-this.startPoint.y;this.currentShape.data.width=s,this.currentShape.data.height=i,this._drawPreview()}_onMouseUp({point:t,event:e}){this.isDrawing&&(this.isDrawing=!1,Math.abs(this.currentShape.data.width)>2&&Math.abs(this.currentShape.data.height)>2&&this.drawer.addShape(this.currentShape),this.currentShape=null,this.startPoint=null)}_drawPreview(){this.drawer.ctx.clearRect(0,0,this.drawer.canvas.width,this.drawer.canvas.height),this.drawer.getShapes().forEach(t=>{t.draw(this.drawer.ctx)}),this.drawer.ctx.save(),this.drawer.ctx.strokeStyle=this.currentShape.data.color,this.drawer.ctx.lineWidth=this.currentShape.data.lineWidth,this.drawer.ctx.setLineDash([5,5]),this.drawer.ctx.strokeRect(this.currentShape.data.x,this.currentShape.data.y,this.currentShape.data.width,this.currentShape.data.height),this.drawer.ctx.restore()}_unbindEvents(){this.isDrawing=!1,this.currentShape=null,this.startPoint=null,this.drawer.resetEvent()}containsPoint(t,e=5){return u(t,this.data,e)}}class x extends g{constructor(t){super(t),this.name="circle",this.centerPoint=null,this.radius=0}_onMouseDown({point:t,event:e}){this.isDrawing=!0,this.centerPoint=t,this.radius=0,this.currentShape=this._createShape("circle",{x:t.x,y:t.y,radius:0})}_onMouseMove({point:t,event:e}){if(!this.isDrawing)return;const s=t.x-this.centerPoint.x,i=t.y-this.centerPoint.y;this.radius=Math.sqrt(s*s+i*i),this.currentShape.data.radius=this.radius,this._drawPreview()}_onMouseUp({point:t,event:e}){this.isDrawing&&(this.isDrawing=!1,this.radius>2&&this.drawer.addShape(this.currentShape),this.centerPoint=null,this.radius=0,this.currentShape=null)}_drawPreview(){this.drawer.ctx.clearRect(0,0,this.drawer.canvas.width,this.drawer.canvas.height),this.drawer.getShapes().forEach(t=>{t.draw(this.drawer.ctx)}),this.drawer.ctx.save(),this.drawer.ctx.strokeStyle=this.currentShape.data.color,this.drawer.ctx.lineWidth=this.currentShape.data.lineWidth,this.drawer.ctx.setLineDash([5,5]),this.drawer.ctx.beginPath(),this.drawer.ctx.arc(this.centerPoint.x,this.centerPoint.y,this.radius,0,2*Math.PI),this.drawer.ctx.stroke(),this.drawer.ctx.restore()}_unbindEvents(){this.isDrawing=!1,this.centerPoint=null,this.radius=0,this.currentShape=null,this.drawer.resetEvent()}containsPoint(t,e=5){return p(t,this.data,e)}}class S extends g{constructor(t){super(t),this.name="polygon",this.points=[],this.isComplete=!1}_onMouseDown({point:t,event:e}){this.isComplete||(this.isDrawing?(this.points.push(t),this.currentShape.data.points=this.points,this._drawPreview()):(this.isDrawing=!0,this.points=[t],this.currentShape=this._createShape("polygon",{points:[t],isComplete:!1})))}_onMouseMove({point:t,event:e}){this.isDrawing&&!this.isComplete&&this._drawPreview(t)}_onDoubleClick({point:t,event:e}){this.isDrawing&&!this.isComplete&&this.points.length>=2&&this._completePolygon()}_completePolygon(){this.isComplete=!0,this.currentShape.data.isComplete=!0,this.currentShape.data.points=[...this.points],this.points.length>=3&&this.drawer.addShape(this.currentShape),this._reset()}_drawPreview(t=null){if(this.drawer.ctx.clearRect(0,0,this.drawer.canvas.width,this.drawer.canvas.height),this.drawer.getShapes().forEach(t=>{t.draw(this.drawer.ctx)}),0!==this.points.length){this.drawer.ctx.save(),this.drawer.ctx.strokeStyle=this.currentShape.data.color,this.drawer.ctx.lineWidth=this.currentShape.data.lineWidth,this.drawer.ctx.setLineDash([5,5]),this.drawer.ctx.beginPath(),this.drawer.ctx.moveTo(this.points[0].x,this.points[0].y);for(let t=1;t<this.points.length;t++)this.drawer.ctx.lineTo(this.points[t].x,this.points[t].y);t&&this.points.length>0&&(this.points[this.points.length-1],this.drawer.ctx.lineTo(t.x,t.y)),this.drawer.ctx.lineTo(this.points[0].x,this.points[0].y),this.drawer.ctx.stroke(),this.drawer.ctx.restore()}}_reset(){this.isDrawing=!1,this.isComplete=!1,this.points=[],this.currentShape=null,this.drawer.resetEvent()}_unbindEvents(){this._reset()}containsPoint(t,e=5){return d(t,this.data.points)}}class y extends g{constructor(t){super(t),this.name="select",this.selectedShape=null,this.isDragging=!1,this.dragStartPoint=null,this.originalShapePosition=null}_onMouseDown({point:t,event:e}){const s=this._findShapeAtPoint(t);s?(this.selectedShape=s,this.isDragging=!0,this.dragStartPoint=t,this.originalShapePosition=this._getShapePosition(s),this.drawer.eventManager.emit("shapeSelected",{shape:s,point:t}),this._drawSelectionHighlight()):this._clearSelection()}_onMouseMove({point:t,event:e}){if(!this.isDragging||!this.selectedShape)return;const s=t.x-this.dragStartPoint.x,i=t.y-this.dragStartPoint.y;this._moveShape(this.selectedShape,s,i),this.dragStartPoint=t,this._redrawCanvas(),this._drawSelectionHighlight()}_onMouseUp({point:t,event:e}){this.isDragging&&this.selectedShape&&this.drawer.eventManager.emit("shapeMoved",{shape:this.selectedShape,from:this.originalShapePosition,to:this._getShapePosition(this.selectedShape)}),this.isDragging=!1,this.dragStartPoint=null,this.originalShapePosition=null}_findShapeAtPoint(t,e=5){const s=this.drawer.getShapes();for(let i=s.length-1;i>=0;i--){const r=s[i];if(this._isPointInShape(t,r,e))return r}return null}_isPointInShape(t,e,s){switch(e.type){case"rectangle":return u(t,e.data,s);case"circle":return p(t,e.data,s);case"polygon":return d(t,e.data.points);case"brush":return this._isPointInBrush(t,e.data,s);default:return!1}}_isPointInBrush(t,e,s){const{points:i,lineWidth:r}=e;if(i.length<2)return!1;for(let e=1;e<i.length;e++){if(c(t,i[e-1],i[e])<=r/2+s)return!0}return!1}_moveShape(t,e,s){switch(t.type){case"rectangle":case"circle":t.data.x+=e,t.data.y+=s;break;case"polygon":case"brush":t.data.points.forEach(t=>{t.x+=e,t.y+=s})}}_getShapePosition(t){switch(t.type){case"rectangle":case"circle":return{x:t.data.x,y:t.data.y};case"polygon":const e=t.data.points;return{x:e.reduce((t,e)=>t+e.x,0)/e.length,y:e.reduce((t,e)=>t+e.y,0)/e.length};case"brush":const s=t.data.points[0];return{x:s.x,y:s.y};default:return{x:0,y:0}}}_drawSelectionHighlight(){if(this.selectedShape){switch(this.drawer.ctx.save(),this.drawer.ctx.strokeStyle="#007bff",this.drawer.ctx.lineWidth=2,this.drawer.ctx.setLineDash([5,5]),this.selectedShape.type){case"rectangle":const t=this.selectedShape.data;this.drawer.ctx.strokeRect(t.x-3,t.y-3,t.width+6,t.height+6);break;case"circle":const e=this.selectedShape.data;this.drawer.ctx.beginPath(),this.drawer.ctx.arc(e.x,e.y,e.radius+3,0,2*Math.PI),this.drawer.ctx.stroke();break;case"polygon":const s=this.selectedShape.data;if(s.points.length>=3){this.drawer.ctx.beginPath(),this.drawer.ctx.moveTo(s.points[0].x,s.points[0].y);for(let t=1;t<s.points.length;t++)this.drawer.ctx.lineTo(s.points[t].x,s.points[t].y);this.drawer.ctx.closePath(),this.drawer.ctx.stroke()}}this.drawer.ctx.restore()}}_clearSelection(){this.selectedShape&&this.drawer.eventManager.emit("shapeDeselected",{shape:this.selectedShape}),this.selectedShape=null,this._redrawCanvas()}_redrawCanvas(){this.drawer.ctx.clearRect(0,0,this.drawer.canvas.width,this.drawer.canvas.height),this.drawer.getShapes().forEach(t=>{t.draw(this.drawer.ctx)})}_unbindEvents(){this._clearSelection(),this.isDragging=!1,this.dragStartPoint=null,this.originalShapePosition=null,this.drawer.resetEvent()}}const f={BRUSH:"brush",RECTANGLE:"rectangle",CIRCLE:"circle",POLYGON:"polygon",SELECT:"select"},_={width:800,height:600,backgroundColor:"#ffffff",defaultColor:"#000000",defaultLineWidth:2};t.BrushTool=w,t.CanvasDrawer=o,t.CircleTool=x,t.DefaultConfig=_,t.PolygonTool=S,t.RectangleTool=v,t.SelectTool=y,t.ToolType=f,t.default=class{constructor(t,e={}){if(this.config={..._,...e},this.container="string"==typeof t?document.querySelector(t):t,!this.container)throw new Error(`Container with "${t}" not found`);this.drawer=new o(this.container,this.config),this.currentTool=null,this.tools=new Map,this._initializeTools()}_initializeTools(){this.registerTool(f.BRUSH,new w(this.drawer)),this.registerTool(f.RECTANGLE,new v(this.drawer)),this.registerTool(f.CIRCLE,new x(this.drawer)),this.registerTool(f.POLYGON,new S(this.drawer)),this.registerTool(f.SELECT,new y(this.drawer)),this.setTool(f.BRUSH)}registerTool(t,e){return this.tools.set(t,e),this}setTool(t){this.currentTool&&this.currentTool.deactivate();const e=this.tools.get(t);return e&&(this.currentTool=e,this.currentTool.activate()),this}setColor(t){return this.drawer.setColor(t),this}setLineWidth(t){return this.drawer.setLineWidth(t),this}clear(){return this.drawer.clear(),this}getShapes(){return this.drawer.getShapes()}addShape(t){return this.drawer.addShape(t),this}removeShape(t){return this.drawer.removeShape(t),this}exportImage(t="image/png",e=1){return this.drawer.exportImage(t,e)}importData(t){return this.drawer.importData(t),this}exportData(){return this.drawer.exportData()}destroy(){this.drawer.destroy(),this.tools.clear(),this.currentTool=null}on(t,e){return this.drawer.on(t,e),this}off(t,e){return this.drawer.off(t,e),this}},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=canvas-drawing-tool.umd.js.map
